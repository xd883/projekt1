
- name: Install and configure AdGuard Home with LVM RAID1 on Debian
  hosts: adguard         
  become: true
  vars:
    adg_pvs:
      - /dev/sdb
      - /dev/sdc
    vg_name: adg_vg
    lv_name: adg_lv
    mount_point: /adguardhome
    filesystem: ext4
    adguard_tmp: /tmp/AdGuardHome.tar.gz
    adguard_download_url: "https://github.com/AdguardTeam/AdGuardHome/releases/latest/download/AdGuardHome_linux_amd64.tar.gz"
    adguard_ports:
      - { proto: tcp, port: 22 }     
      - { proto: tcp, port: 80 }     
      - { proto: tcp, port: 443 }   
      - { proto: tcp, port: 3000 }   
      - { proto: udp, port: 53 }     
      - { proto: tcp, port: 53 }     
      - { proto: tcp, port: 853 }    

  tasks:


    - name: Create installation directory for AdGuardHome
      file:
        path: /opt/adguardhome
        state: directory
        owner: root
        group: root
        mode: '0755'
    - name: Download AdGuard Home
      get_url:
        url: "{{ adguard_download_url }}"
        dest: /tmp/AdGuardHome.tar.gz

    - name: Extract AdGuard Home
      unarchive:
        src: /tmp/AdGuardHome.tar.gz
        dest: /opt/adguardhome
        remote_src: yes   
        extra_opts: ["--strip-components=1"]


    - name: Ensure ownership and permissions
      file:
        path: /opt/adguardhome/AdGuardHome
        owner: root
        group: root
        mode: '0755'


    - name: Ensure AdGuardHome binary is executable
      file:
        path: "{{ mount_point }}/AdGuardHome"
        mode: "0755"

    - name: Install AdGuardHome as systemd service
      command: /opt/adguardhome/AdGuardHome -s install
      become: true
      become_user: root
      args:
        creates: /etc/systemd/system/AdGuardHome.service


    - name: Enable UFW with deny policy
      ufw:
        state: enabled
        policy: deny

    - name: Allow required ports in UFW
      ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
      loop: "{{ adguard_ports }}"

    - name: Reload UFW
      command: ufw reload

    - name: Enable and start AdGuardHome
      systemd:
        name: AdGuardHome
        enabled: yes
        state: started
