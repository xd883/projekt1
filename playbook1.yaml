
- name: Install and configure AdGuard Home with LVM RAID1 on Debian
  hosts: adguard
  become: true

  vars:
    adg_pvs:
      - /dev/sdb
      - /dev/sdc
    vg_name: adg_vg
    lv_name: adg_lv
    mount_point: /adguardhome
    filesystem: ext4
    adguard_tmp: /tmp/AdGuardHome.tar.gz
    adguard_download_url: "https://github.com/AdguardTeam/AdGuardHome/releases/latest/download/AdGuardHome_linux_amd64.tar.gz"
    adguard_ports:
      - { proto: tcp, port: 22 }
      - { proto: tcp, port: 80 }
      - { proto: tcp, port: 443 }
      - { proto: tcp, port: 3000 }
      - { proto: udp, port: 53 }
      - { proto: tcp, port: 53 }
      - { proto: tcp, port: 853 }

  tasks:

    - name: Install required system packages
      apt:
        name:
          - lvm2
          - util-linux
          - wget
          - tar
          - ufw
        state: present
        update_cache: yes


    - name: Check if specified disks exist
      stat:
        path: "{{ item }}"
      loop: "{{ adg_pvs }}"
      register: disk_check

    - name: Fail if required disks don't exist
      fail:
        msg: "Disk {{ item.item }} does not exist! LVM will not be configured."
      when: not item.stat.exists
      loop: "{{ disk_check.results }}"


    - name: Create physical volumes if not already PVs
      command: "pvcreate -ff -y {{ item }}"
      loop: "{{ adg_pvs }}"
      when: "'{{ item }}' not in ansible_facts.lvm.pvs"
      register: pv_create
      failed_when: false    # prevents failure if PV exists
      changed_when: "'successfully' in pv_create.stdout"

    - name: Create volume group if missing
      lvg:
        vg: "{{ vg_name }}"
        pvs: "{{ adg_pvs }}"
        pesize: 4
      register: vg_result

    - name: Create mirrored LV (RAID1) idempotent
      lvol:
        vg: "{{ vg_name }}"
        lv: "{{ lv_name }}"
        size: "10g"
        opts: "-m1"
        state: present


    - name: Create filesystem if missing
      filesystem:
        fstype: "{{ filesystem }}"
        dev: "/dev/{{ vg_name }}/{{ lv_name }}"

    - name: Ensure mount directory exists
      file:
        path: "{{ mount_point }}"
        state: directory
        mode: "0755"

    - name: Check if LV is already mounted
      command: findmnt -n {{ mount_point }}
      register: lv_mounted
      failed_when: false
      changed_when: false

    - name: Mount LV and add to fstab
      mount:
        path: "{{ mount_point }}"
        src: "/dev/{{ vg_name }}/{{ lv_name }}"
        fstype: "{{ filesystem }}"
        state: mounted
      when: lv_mounted.rc != 0


    - name: Create installation directory
      file:
        path: /opt/adguardhome
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Download AdGuard Home 
      get_url:
        url: "{{ adguard_download_url }}"
        dest: "{{ adguard_tmp }}"
        mode: "0644"

    - name: Extract only if AdGuardHome binary missing
      unarchive:
        src: "{{ adguard_tmp }}"
        dest: /opt/adguardhome
        remote_src: yes
       

    - name: Ensure binary permissions
      file:
        path: /opt/adguardhome/AdGuardHome
        mode: "0755"

    - name: Install AdGuardHome system service if missing
      command: /opt/adguardhome/AdGuardHome -s install
      become: true
      args:
        creates: /etc/systemd/system/AdGuardHome.service
    - name: Enable UFW with deny policy
      ufw:
        state: enabled
        policy: deny

    - name: Allow required ports
      ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
      loop: "{{ adguard_ports }}"

    - name: Reload UFW
      command: ufw reload


    - name: Enable and start AdGuardHome
      systemd:
        name: AdGuardHome
        enabled: yes
        state: started
