---
- name: Backup AdGuard Home to remote server
  hosts: adguard
  become: true
  vars:
    adguard_dir: /opt/adguardhome/AdGuardHome
    backup_temp_dir: /tmp/adguard_backup
    backup_filename: "adguard_backup.tar.gz"
    remote_backup_dir: /backups/adguard

  tasks:

    - name: Ensure local backup temp directory exists
      file:
        path: "{{ backup_temp_dir }}"
        state: directory
        mode: "0755"

    - name: Create compressed backup archive
      archive:
        path: "{{ adguard_dir }}"
        dest: "{{ backup_temp_dir }}/{{ backup_filename }}"
        format: gz

    - name: Ensure remote backup directory exists
      file:
        path: "{{ remote_backup_dir }}"
        state: directory
        mode: "0755"
      delegate_to: localhost
      become: false

    - name: Copy backup archive to remote backup server
      copy:
        src: "{{ backup_temp_dir }}/{{ backup_filename }}"
        dest: "{{ remote_backup_dir }}/{{ backup_filename }}"
      delegate_to: localhost
      become: false

    - name: Cleanup local temp backup directory
      file:
        path: "{{ backup_temp_dir }}"
        state: absent
