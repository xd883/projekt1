- name: Backup AdGuardHome directory from remote server to localhost
  hosts: adguard
  become: true

  vars:
    adguard_dir: /opt/adguardhome
    local_backup_dir: "/tmp/backups/adguard_{{ ansible_date_time.date }}"

  tasks:

    - name: Ensure local backup directory exists on controller
      delegate_to: localhost
      file:
        path: "{{ local_backup_dir }}"
        state: directory
        mode: "0755"

    - name: Fetch full AdGuardHome directory to localhost
      fetch:
        src: "{{ adguard_dir }}/"
        dest: "{{ local_backup_dir }}/"
        flat: no


    - name: Cleanup local temp backup directory
      file:
        path: "{{ backup_temp_dir }}"
        state: absent
