---
- name: Playbook 4 - Konfiguracja Puli Dyskowej, Udziału i Pozostałe 
  hosts: winsrv
  gather_facts: no
  vars:
    
    nazwisko: "langier"            
    pool_name: "Pool_langier"
    vdisk_name: "VD_langier"
    vd_drive_letter: "F"
    share_name: "Projekty_langier"
    projekty_path: "F:\\Projekty"
    group_name: "Kierownicy_langier"
    users:
      - name: "Marek.Romanek"
        fullname: "Marek Romanek"
        password: "Zaq12wsx"   
      - name: "Jacek.Gula"
        fullname: "Jacek Gula"
        password: "Zaq12wsx"  
    winget_packages:
      - id: "7zip.7zip"
      - id: "ISC.BIND"         
      - id: "Mozilla.Firefox"
  tasks:

  - name: Utwórz pulę dyskową, storage tiers i wirtualny dysk F
  ansible.windows.win_powershell:
    script: |
      $poolName = "{{ pool_name }}"
      $vdName = "{{ vdisk_name }}"
      $driveLetter = "{{ vd_drive_letter }}"

      $canpool = Get-PhysicalDisk -CanPool $true

      if ($canpool.Count -lt 1) {
        Write-Error "Brak dysków z CanPool=True."
        exit 1
      }

      $pool = Get-StoragePool -FriendlyName $poolName -ErrorAction SilentlyContinue

      if (-not $pool) {
        $pool = New-StoragePool -FriendlyName $poolName -StorageSubSystemFriendlyName "Storage Spaces*" -PhysicalDisks $canpool
        Write-Output "Storage Pool $poolName utworzony."
      } else {
        Write-Output "Storage Pool $poolName już istnieje."
      }
      $ssdTier = Get-StorageTier -FriendlyName "SSDTier" -ErrorAction SilentlyContinue
      if (-not $ssdTier) {
        $ssdTier = $pool | New-StorageTier -FriendlyName "SSDTier" -MediaType SSD
        Write-Output "Tier SSD utworzony."
      }

      $hddTier = Get-StorageTier -FriendlyName "HDDTier" -ErrorAction SilentlyContinue
      if (-not $hddTier) {
        $hddTier = $pool | New-StorageTier -FriendlyName "HDDTier" -MediaType HDD
        Write-Output "Tier HDD utworzony."
      }

      $ssdSize = ($pool | Get-PhysicalDisk | where MediaType -eq SSD | Measure-Object Size -Sum).Sum
      $hddSize = ($pool | Get-PhysicalDisk | where MediaType -eq HDD | Measure-Object Size -Sum).Sum

      if (-not (Get-VirtualDisk -FriendlyName $vdName -ErrorAction SilentlyContinue)) {
        New-VirtualDisk `
          -StoragePoolFriendlyName $poolName `
          -FriendlyName $vdName `
          -ResiliencySettingName Mirror `
          -StorageTiers @($ssdTier, $hddTier) `
          -StorageTierSizes @($ssdSize, $hddSize)

        Write-Output "VirtualDisk $vdName utworzony."
      } else {
        Write-Output "VirtualDisk $vdName już istnieje."
      }

      $vd = Get-VirtualDisk -FriendlyName $vdName
      $disk = $vd | Get-Disk

      if ($disk.IsOffline) {
        Set-Disk -Number $disk.Number -IsOffline $false
      }

      if ($disk.PartitionStyle -eq 'RAW') {
        Initialize-Disk -Number $disk.Number -PartitionStyle GPT
        New-Partition -DiskNumber $disk.Number -UseMaximumSize -DriveLetter $driveLetter | Out-Null
        Format-Volume -DriveLetter $driveLetter -FileSystem ReFS -Confirm:$false | Out-Null
        Write-Output "Dysk $driveLetter: sformatowany w ReFS."
      } else {
        Write-Output "Dysk już zainicjalizowany."
      }

      Write-Output "Dysk $driveLetter: gotowy."
  register: storage_result

  - name: Utwórz lokalną grupę Kierownicy_langier
    ansible.windows.win_group:
      name: "{{ group_name }}"
      state: present

  - name: Utwórz użytkowników lokalnych i ustaw hasła
    ansible.windows.win_user:
      name: "{{ item.name }}"
      password: "{{ item.password }}"
      description: "{{ item.fullname }}"
      state: present
    loop: "{{ users }}"

  - name: Dodaj użytkowników do grupy Kierownicy_langier
    ansible.windows.win_group:
      name: "{{ group_name }}"
      members: "{{ users | map(attribute='name') | list }}"
      state: present

  - name: Utwórz katalog Projekty na dysku F
    ansible.windows.win_file:
      path: "{{ projekty_path }}"
      state: directory
      recurse: yes

  - name: Utwórz udział sieciowy Projekty_langier
    ansible.windows.win_share:
      name: "{{ share_name }}"
      path: "{{ projekty_path }}"
      description: "Projekty dla grupy {{ group_name }}"
      list: yes
      full: ".\\Administrators, .\\{{ group_name }}"
      state: present

  - name: Nadaj ACL NTFS pełny dostęp dla grupy 
    ansible.windows.win_acl:
      path: "{{ projekty_path }}"
      user: ".\\{{ group_name }}"
      rights: "full"
      type: allow
      inheritance: "ContainerInherit, ObjectInherit"
      propagate: no
      state: present

  - name: Usuń inne uprawnienia odziedziczone 
    ansible.windows.win_acl:
      path: "{{ projekty_path }}"
      user: "BUILTIN\\Users"
      state: absent
      recurse: no
      fail_on_missing: false

  - name: Zainstaluj aplikacje przez winget (7zip, dig (ISC.BIND), Firefox)
    ansible.windows.win_shell:
      args:
        executable: powershell.exe
      cmd: |
        $ErrorActionPreference = 'Continue'
        {{- for pkg in winget_packages }}
        winget install --id {{ pkg.id }} -e --accept-source-agreements --accept-package-agreements || Write-Output "winget install {{ pkg.id }} zwrócił błąd ale kontynuujemy"
        {{- endfor }}
    register: winget_result

  - name: Ustawienie rejestru zablokuj usuwanie drukarek dla użytkowników bez uprawnień administracyjnych
    ansible.windows.win_powershell:
      script: |
        $adminSIDs = (Get-LocalGroupMember -Group "Administrators" -ErrorAction SilentlyContinue | ForEach-Object { $_.SID.Value }) | Where-Object { $_ }
        $profiles = Get-CimInstance -ClassName Win32_UserProfile | Where-Object { $_.LocalPath -and (Test-Path $_.LocalPath) }

        foreach ($p in $profiles) {
          try {
            $sid = $p.SID
            $isAdmin = $false
            try {
              $acct = New-Object System.Security.Principal.SecurityIdentifier($sid).Translate([System.Security.Principal.NTAccount]).Value
              $parts = $acct.Split('\')
              $userName = $acct
              $members = Get-LocalGroupMember -Group "Administrators" -ErrorAction SilentlyContinue | ForEach-Object { $_.Name }
              if ($members -contains $userName) { $isAdmin = $true }
            } catch {
            }

            if (-not $isAdmin) {
              $hive = "HKU\$sid"
              $ntuser = Join-Path $p.LocalPath "NTUSER.DAT"
              if (-not (Get-ChildItem "Registry::${hive}" -ErrorAction SilentlyContinue)) {
                reg.exe load "HKU\$sid" "$ntuser" > $null 2>&1
                $loaded = $true
              } else {
                $loaded = $false
              }

              $explorerKey = "Registry::${hive}\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer"
              if (-not (Test-Path $explorerKey)) {
                New-Item -Path $explorerKey -Force | Out-Null
              }

              New-ItemProperty -Path $explorerKey -Name "NoDeletePrinter" -PropertyType DWord -Value 1 -Force | Out-Null

              if ($loaded) {
                reg.exe unload "HKU\$sid" > $null 2>&1
              }
            } else {
              Write-Output "Użytkownik z SID $sid jest administratorem — pomijam."
            }
          } catch {
            Write-Output "Błąd przetwarzania profilu: $($_.Exception.Message)"
          }
        }
    register: printer_policy_result

  - name: Podsumowanie — wyświetl status operacji storage/install/registry
    ansible.builtin.debug:
      msg:
        - "Storage: {{ storage_result.stdout if storage_result is defined else 'brak outputu' }}"
        - "Winget: {{ winget_result.stdout if winget_result is defined else 'brak outputu' }}"
        - "Registry (NoDeletePrinter): {{ printer_policy_result.stdout if printer_policy_result is defined else 'brak outputu' }}"
